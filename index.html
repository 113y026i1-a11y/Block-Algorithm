<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ¼”ç®—æ³•ç©æœ¨å¯¦é©—å®¤</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #blocklyDiv { width: 65%; height: 100%; border-right: 1px solid #ccc; }
        #outputArea { width: 35%; padding: 20px; background-color: #f9f9f9; display: flex; flex-direction: column; }
        h2 { margin-top: 0; color: #333; }
        .control-panel { margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #45a049; }
        #console { background: #222; color: #0f0; padding: 15px; border-radius: 5px; flex-grow: 1; overflow-y: auto; font-family: monospace; white-space: pre-wrap; }
        .file-input-group { margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="blocklyDiv"></div>

    <div id="outputArea">
        <h2>ğŸš€ æ¼”ç®—æ³•æ§åˆ¶å°</h2>
        
        <div class="control-panel">
            <div class="file-input-group">
                <label>1. æº–å‚™è³‡æ–™ (ä¸Šå‚³ .txt æˆ– .csv):</label><br>
                <input type="file" id="fileInput" accept=".txt,.csv,.json">
            </div>
            <div>
                <label>2. åŸ·è¡Œæ¼”ç®—æ³•:</label><br>
                <button onclick="runCode()">â–¶ï¸ åŸ·è¡Œç©æœ¨ç¨‹å¼</button>
            </div>
        </div>

        <label>åŸ·è¡Œçµæœ:</label>
        <div id="console">ç­‰å¾…åŸ·è¡Œ...</div>
    </div>

    <script>
        // --- 1. å®šç¾©è‡ªå®šç¾©ç©æœ¨ (Custom Blocks) ---

        // ç©æœ¨ï¼šå–å¾—ä¸Šå‚³çš„æª”æ¡ˆå…§å®¹
        Blockly.Blocks['get_file_content'] = {
            init: function() {
                this.appendDummyInput().appendField("ğŸ“‚ è®€å–ä¸Šå‚³çš„æª”æ¡ˆå…§å®¹");
                this.setOutput(true, "String");
                this.setColour(230);
                this.setTooltip("å›å‚³ä½¿ç”¨è€…ä¸Šå‚³æª”æ¡ˆçš„æ–‡å­—å…§å®¹");
            }
        };

        // ç©æœ¨ï¼šAI é—œéµå­—åˆ†æ (æ¨¡æ“¬ AI è§£è®€)
        Blockly.Blocks['ai_analyze_sentiment'] = {
            init: function() {
                this.appendValueInput("TEXT").setCheck("String").appendField("ğŸ§  AI åˆ†ææ–‡æœ¬");
                this.appendDummyInput().appendField("æ˜¯å¦åŒ…å«é—œéµå­—");
                this.appendValueInput("KEYWORD").setCheck("String");
                this.setOutput(true, "Boolean");
                this.setColour(160);
                this.setTooltip("ç°¡å–®çš„è¦å‰‡å¼ AIï¼Œæª¢æŸ¥æ–‡æœ¬æ˜¯å¦åŒ…å«ç‰¹å®šæ¦‚å¿µ");
            }
        };

        // ç©æœ¨ï¼šæ¨è–¦ç³»çµ± - è¨ˆç®—åˆ†æ•¸
        Blockly.Blocks['calc_recommendation_score'] = {
            init: function() {
                this.appendValueInput("BASE").setCheck("Number").appendField("ğŸ“Š æ¨è–¦æ¼”ç®—æ³•ï¼šåŸºç¤åˆ†");
                this.appendValueInput("WEIGHT").setCheck("Number").appendField("x æ¬Šé‡");
                this.setOutput(true, "Number");
                this.setColour(60);
                this.setTooltip("è¨ˆç®—æ¨è–¦æ¬Šé‡åˆ†æ•¸");
            }
        };

        // ç©æœ¨ï¼šè¼¸å‡ºçµæœ
        Blockly.Blocks['print_log'] = {
            init: function() {
                this.appendValueInput("MSG").setCheck(null).appendField("ğŸ–¨ï¸ è¼¸å‡ºçµæœåˆ°æ§åˆ¶å°");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(0);
            }
        };

        // --- 2. å®šç¾©ç©æœ¨çš„ JavaScript è½‰æ›é‚è¼¯ (Generators) ---

        const javascript = Blockly.javascript;

        javascript.javascriptGenerator.forBlock['get_file_content'] = function(block) {
            // å‘¼å«æˆ‘å€‘å®šç¾©åœ¨å…¨åŸŸçš„ helper function
            return ['getFileContent()', javascript.Order.ATOMIC];
        };

        javascript.javascriptGenerator.forBlock['ai_analyze_sentiment'] = function(block) {
            const text = javascript.javascriptGenerator.valueToCode(block, 'TEXT', javascript.Order.NONE) || "''";
            const keyword = javascript.javascriptGenerator.valueToCode(block, 'KEYWORD', javascript.Order.NONE) || "''";
            // ç”¢ç”Ÿæª¢æŸ¥æ˜¯å¦åŒ…å«å­—ä¸²çš„ç¨‹å¼ç¢¼
            const code = `${text}.includes(${keyword})`;
            return [code, javascript.Order.Eq];
        };

        javascript.javascriptGenerator.forBlock['calc_recommendation_score'] = function(block) {
            const base = javascript.javascriptGenerator.valueToCode(block, 'BASE', javascript.Order.ATOMIC) || '0';
            const weight = javascript.javascriptGenerator.valueToCode(block, 'WEIGHT', javascript.Order.ATOMIC) || '1';
            const code = `(${base} * ${weight})`;
            return [code, javascript.Order.MULTIPLICATION];
        };

        javascript.javascriptGenerator.forBlock['print_log'] = function(block) {
            const msg = javascript.javascriptGenerator.valueToCode(block, 'MSG', javascript.Order.ATOMIC) || "''";
            return `logToConsole(${msg});\n`;
        };

        // --- 3. åˆå§‹åŒ– Blockly å·¥ä½œå€ ---

        const workspace = Blockly.inject('blocklyDiv', {
            toolbox: {
                "kind": "categoryToolbox",
                "contents": [
                    {
                        "kind": "category",
                        "name": "æ ¸å¿ƒé‚è¼¯",
                        "colour": "210",
                        "contents": [
                            { "kind": "block", "type": "controls_if" },
                            { "kind": "block", "type": "controls_repeat_ext" },
                            { "kind": "block", "type": "logic_compare" },
                            { "kind": "block", "type": "math_number" },
                            { "kind": "block", "type": "text" }
                        ]
                    },
                    {
                        "kind": "category",
                        "name": "æ•¸æ“šèˆ‡ AI",
                        "colour": "160",
                        "contents": [
                            { "kind": "block", "type": "get_file_content" },
                            { "kind": "block", "type": "ai_analyze_sentiment" },
                            { "kind": "block", "type": "calc_recommendation_score" },
                            { "kind": "block", "type": "print_log" }
                        ]
                    }
                ]
            }
        });

        // é è¨­ç”¢ç”Ÿä¸€äº›ç©æœ¨
        const xmlText = `<xml xmlns="https://developers.google.com/blockly/xml">
            <block type="print_log" x="50" y="50">
                <value name="MSG">
                    <block type="text">
                        <field name="TEXT">ç³»çµ±å•Ÿå‹•...</field>
                    </block>
                </value>
                <next>
                    <block type="controls_if">
                        <value name="IF0">
                            <block type="ai_analyze_sentiment">
                                <value name="TEXT">
                                    <block type="get_file_content"></block>
                                </value>
                                <value name="KEYWORD">
                                    <block type="text">
                                        <field name="TEXT">å–œæ­¡</field>
                                    </block>
                                </value>
                            </block>
                        </value>
                        <statement name="DO0">
                            <block type="print_log">
                                <value name="MSG">
                                    <block type="text">
                                        <field name="TEXT">åµæ¸¬åˆ°ä½¿ç”¨è€…åå¥½ï¼æ¨è–¦æ¼”ç®—æ³•å•Ÿå‹•ï¼</field>
                                    </block>
                                </value>
                            </block>
                        </statement>
                    </block>
                </next>
            </block>
        </xml>`;
        Blockly.Xml.domToWorkspace(Blockly.utils.xml.textToDom(xmlText), workspace);


        // --- 4. åŸ·è¡Œç’°å¢ƒ (Runtime) ---

        let fileContent = "";

        // ç›£è½æª”æ¡ˆä¸Šå‚³
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                fileContent = e.target.result;
                logToConsole(`ç³»çµ±: æª”æ¡ˆè®€å–æˆåŠŸ (${file.name})`);
            };
            reader.readAsText(file);
        });

        // Helper function: ä¾›ç©æœ¨å‘¼å«
        function getFileContent() {
            if (!fileContent) return "å°šæœªè®€å–æª”æ¡ˆæˆ–æª”æ¡ˆç‚ºç©º";
            return fileContent;
        }

        // Helper function: è¼¸å‡ºåˆ°ç•«é¢
        function logToConsole(msg) {
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML += `> ${msg}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        // åŸ·è¡ŒæŒ‰éˆ•é‚è¼¯
        function runCode() {
            document.getElementById('console').innerHTML = "--- é–‹å§‹åŸ·è¡Œ ---\n";
            // å°‡ç©æœ¨è½‰ç‚ºç¨‹å¼ç¢¼
            const code = javascript.javascriptGenerator.workspaceToCode(workspace);
            
            try {
                // å±éšªå‹•ä½œè­¦å‘Š: åœ¨æ­£å¼ç”¢å“ä¸­æ‡‰ä½¿ç”¨æ›´å®‰å…¨çš„è§£é‡‹å™¨ (Interpreter)ï¼Œ
                // ä½†ç‚ºäº†å–®ä¸€ HTML æª”æ¡ˆçš„ç°¡ä¾¿æ€§ï¼Œé€™è£¡ä½¿ç”¨ eval()ã€‚
                eval(code); 
            } catch (e) {
                logToConsole(`éŒ¯èª¤: ${e}`);
            }
        }
    </script>
</body>
</html>
